---
title: "diagExamples"
author: "Rachel Wilkerson"
date: "22 October 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load(file = "examples.Rdata")
```

## CHDS example

The CHDS data here is supplied by Rodriguo Collazo. The CEG.AHC is found in Lorna Barclay's thesis.
```{r, eval=FALSE}
chds.df <-read.csv(file = "CHDS.latentexample1.csv")#,stringsAsFactors = F) #note: sst requires factors
chds.sst <- CEG.AHC(chds.df)
```

The staging is found in the results. Results shows the incoming edges contributing to each of the stages
```{r}
chds.sst$result
```

These functions take the output of Lorna's code and transform it to run in Rachel's functions. The stage.key is essentially a tidyverse version of the output from results, and struct is the data at each of the stages. 

```{r, eval=FALSE, warning=FALSE}
#translate to run the diagnostic code 
tostagekey(chds.df, chds.sst)-> chds.stage.key
pull(map_df(chds.stage.key, ~distinct(.x,stage)),stage )-> chds.stages#the stages
chds.struct <- to.struct(chds.df,chds.stage.key,chds.sst) #the struct. a weird name for the data results of the AHC alg
chds.cuts <- colnames(chds.df)
```

The code below renders the CEG. w3 and w4 are in the same stage, but not the same position.
```{r}
renderCEG(chds.stage.key,chds.df)
```


This reproduces CEG B as seen in Collazo, Gorgen, Smith book.  
with a Bayes factor score of -2478.49.

The global monitor from Lauritzen is simply the Bayes factor. 

We can see the usefulness of the global monitor by examining the BF of models with different ordering.
```{r}
chds.sst2 <- CEG.AHC(chds.df[,c(2,1,3,4)]) #varorder E S L H 
chds.sst2$lik; #equivalent to chds.sst so same likelihoods 
chds.sst2.sk <- tostagekey(chds.df[,c(2,1,3,4)],sst = chds.sst2)
renderCEG(chds.sst2.sk, chds.df[,c(2,1,3,4)])
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r pressure, echo=FALSE}
plot(pressure)
```







#test against another ordering
chds.sst3 <- CEG.AHC(chds.df[,c(1,3,2,4)])
chds.sst3$lik #same likelihoods because statistically equivalent
chds.sst3.sk <- tostagekey(chds.df[,c(1,3,2,4)],sst = chds.sst3) # var order S L E H 
renderCEG(chds.sst3.sk, chds.df[,c(1,3,2,4)])
chds.sst4 <- CEG.AHC(chds.df[,c(3,1,2,4)])
chds.sst4$lik #same likelihood because statistically equivalent
chds.sst4.sk <- tostagekey(chds.df[,c(3,1,2,4)],sst = chds.sst4) # var order L S E H 
renderCEG(chds.sst4.sk, chds.df[,c(3,1,2,4)])
chds.sst4$result

map(chds.stage.key[-1], ~select(.x,-key))->chds.sk#a little bit of finagling to make it not blow up immediately.
chds.sk <- c(chds.stage.key[1],chds.sk)
chds.prior <-get.ref.prior(df=chds.df,struct=chds.struct,cuts=chds.cuts,stage.key=chds.sk,stages=chds.stages)#check that we can get the prior

#what to do about the first stage
allComponents(targetCut = 2,condtnlCut = 1,df = chds.df,stage.key = chds.sk,stages = chds.stages,struct = chds.struct,chds.prior)
allComponents(targetCut = 3,condtnlCut = 2,df = chds.df,stage.key = chds.sk,stages = chds.stages,struct = chds.struct,chds.prior)
#much of the BF score comes from stage w3 to w1
allComponents(targetCut = 4,condtnlCut = 3,df = chds.df,stage.key = chds.sk,stages = chds.stages,struct = chds.struct,chds.prior)

chds.stage.key[[3]] #High Social, High Economic, High Social and Low Economic are triggering a pretty high error.
#is it strangethat these get lumped in the same stage??
renderCEG(chds.stage.key, chds.df)

#Is there another staging of the situations in cut 3 that would be more appropriate? 
chds.part.monitor <- part.monitor(rho = .7,epsilon = 1.2,df_cut = chds.df,which.cut = 3,stage.key = chds.sk,n.monitor = 860)
#k is 0.9 in freeman paper
#tau is length of lag

#rho = .7;epsilon = 1.2;df_cut = chds.df;which.cut = 3;stage.key = chds.sk;n.monitor = 200#for trblshtng
chds.part.monitor[[3]] %>%
  flatten_dfr()

chds.crrnt.stg.probs <- do.call("rbind", lapply(chds.part.monitor[[3]], "[[", 4)) #possible.coloring 3
chds.alt1.stg.probs <- do.call("rbind", lapply(chds.part.monitor[[3]], "[[", 1))#possible.coloring 10
chds.alt2.stg.probs <- do.call("rbind", lapply(chds.part.monitor[[3]], "[[", 2))#possible.coloring 11
chds.alt3.stg.probs <- do.call("rbind", lapply(chds.part.monitor[[3]], "[[", 3))#possible.coloring 13

possible.colorings[[3]] #(HH, HL, LH) (LL)
possible.colorings[[13]]#(HH) (HL, LH) (LL)

chds.part.df <- as.data.frame(cbind(5:860,chds.crrnt.stg.probs, chds.alt1.stg.probs, chds.alt2.stg.probs, chds.alt3.stg.probs))
colnames(chds.part.df) <- c("t", "currentStage", "AltStage1", "AltStage2", "AltStage3")
chds.part.df %>% 
  gather(key, value, -t) %>%
  ggplot(aes(x=t, y=value, colour=key)) + geom_line()

chds.w3.pach <- ceg.child.parent.monitor(df=chds.df,
                         target.stage = "w3",
                         target.cut = 3, 
                         condtnl.stage = "w1",
                         struct = chds.struct,
                         stage.key = chds.sk, 
                         stages=chds.stages,
                         n = 860,
                         learn = F)
plot(chds.w3.pach[,1])

chds.w3w2.pach <- ceg.child.parent.monitor(df=chds.df,
                                         target.stage = "w3",
                                         target.cut = 3, 
                                         condtnl.stage = "w2",
                                         struct = chds.struct,
                                         stage.key = chds.sk, 
                                         stages=chds.stages,
                                         n = 860,
                                         learn = F)
lines(chds.w3w2.pach[,1])


